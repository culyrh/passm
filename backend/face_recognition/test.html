<!DOCTYPE html>
<html>
<head>
    <title>얼굴 인식 시각화 테스트</title>
    <style>
        body { font-family: Arial; margin: 50px; }
        .container { max-width: 800px; margin: 0 auto; }
        input[type="file"] { margin: 10px 0; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #result { margin-top: 20px; }
        canvas { border: 2px solid #ddd; margin-top: 10px; }
        .info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>얼굴 인식 시각화 테스트</h1>
        <div class="info">
            <p><strong>사용법:</strong></p>
            <p>1. 이미지 파일을 선택하세요</p>
            <p>2. "인식하기" 버튼을 클릭하세요</p>
            <p>3. 찾은 얼굴에 박스가 표시됩니다 (인식 성공: 초록색, 실패: 빨간색)</p>
        </div>
        
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="uploadImage()">인식하기</button>
        
        <div id="result">
            <div id="info"></div>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>
    </div>

    <script>
    function uploadImage() {
        const input = document.getElementById('imageInput');
        const file = input.files[0];
        if (!file) {
            alert('이미지를 선택해주세요!');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        // 로딩 표시
        document.getElementById('info').innerHTML = '🔄 얼굴 인식 중...';

        fetch('http://localhost:8000/recognize_visual', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.faces_found > 0) {
                displayDetailedResults(data);
                drawFaceBoxes(file, data.face_locations || [], data.detailed_results || []);
            } else {
                document.getElementById('info').innerHTML = '❌ 얼굴을 찾을 수 없습니다.';
                document.getElementById('canvas').style.display = 'none';
            }
        })
        .catch(error => {
            document.getElementById('info').innerHTML = '❌ 오류가 발생했습니다: ' + error;
        });
    }

    function displayDetailedResults(data) {
        let html = `<h3>${data.faces_found}개의 얼굴을 찾았습니다!</h3>`;
        
        if (data.detailed_results) {
            data.detailed_results.forEach(result => {
                html += `
                <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid ${result.recognized ? '#28a745' : '#dc3545'};">
                    <h4>[얼굴 ${result.face_number}]</h4>
                    <p><strong>상태:</strong> ${result.status}</p>
                    <p><strong>인식결과:</strong> ${result.celebrity || '알 수 없음'}</p>
                    ${result.confidence ? `<p><strong>신뢰도:</strong> ${result.confidence}%</p>` : ''}
                    ${result.actual_confidence ? `<p><strong>실제 유사도:</strong> ${result.actual_confidence}%</p>` : ''}
                    ${result.best_match ? `<p><strong>가장 유사한 인물:</strong> ${result.best_match}</p>` : ''}
                    <p><strong>위치:</strong> (${result.location.left}, ${result.location.top}) - (${result.location.right}, ${result.location.bottom})</p>
                    <p><strong>크기:</strong> ${result.size.width} × ${result.size.height} pixels (면적: ${result.size.area})</p>
                    ${result.landmarks ? `<p><strong>얼굴 특징점:</strong> ${Object.keys(result.landmarks).length}개 부위 감지</p>` : ''}
                </div>`;
            });
        }
        
        document.getElementById('info').innerHTML = html;
    }

    function drawFaceBoxes(imageFile, faceLocations, detailedResults = []) {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            // 캔버스 크기 조정 (최대 800px)
            const maxWidth = 800;
            const scale = Math.min(maxWidth / img.width, maxWidth / img.height, 1);
            
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            canvas.style.display = 'block';
            
            // 이미지 그리기
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // 얼굴 박스와 랜드마크 그리기
            faceLocations.forEach((face, index) => {
                const x = face.left * scale;
                const y = face.top * scale;
                const width = (face.right - face.left) * scale;
                const height = (face.bottom - face.top) * scale;
                
                const result = detailedResults[index];
                const color = result && result.recognized ? '#28a745' : '#dc3545';
                
                // 박스 그리기
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, width, height);
                
                // 라벨 배경
                const label = result ? `${result.celebrity} (${result.confidence || 0}%)` : `얼굴 ${index + 1}`;
                ctx.font = '14px Arial';
                const textWidth = ctx.measureText(label).width;
                ctx.fillStyle = color;
                ctx.fillRect(x, y - 25, textWidth + 10, 20);
                
                // 라벨 텍스트
                ctx.fillStyle = 'white';
                ctx.fillText(label, x + 5, y - 10);
                
                // 랜드마크 그리기 (있다면)
                if (result && result.landmarks) {
                    ctx.fillStyle = '#ffd700';
                    Object.values(result.landmarks).forEach(points => {
                        points.forEach(point => {
                            ctx.beginPath();
                            ctx.arc(point[0] * scale, point[1] * scale, 1, 0, 2 * Math.PI);
                            ctx.fill();
                        });
                    });
                }
            });
        };
        
        img.src = URL.createObjectURL(imageFile);
    }
    </script>
</body>
</html>